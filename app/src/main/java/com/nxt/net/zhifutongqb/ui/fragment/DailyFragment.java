package com.nxt.net.zhifutongqb.ui.fragment;import android.annotation.SuppressLint;import android.app.AlertDialog;import android.content.DialogInterface;import android.content.Intent;import android.os.Handler;import android.os.Message;import android.support.v4.widget.SwipeRefreshLayout;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.widget.AbsListView;import android.widget.ListView;import com.google.gson.Gson;import com.google.gson.reflect.TypeToken;import com.lzy.okgo.OkGo;import com.lzy.okgo.callback.StringCallback;import com.nxt.net.zhifutongqb.R;import com.nxt.net.zhifutongqb.app.API;import com.nxt.net.zhifutongqb.bean.DailyBean;import com.nxt.net.zhifutongqb.bean.RequestResponse;import com.nxt.net.zhifutongqb.callback.StringBallDialogCallback;import com.nxt.net.zhifutongqb.ui.adapter.CommonAdapter;import com.nxt.net.zhifutongqb.ui.adapter.ViewHolder;import com.nxt.net.zhifutongqb.utils.ZToastUtils;import com.nxt.net.zhifutongqb.widget.ZTitleBar;import com.nxt.net.zhifutongqb.base.ZBaseFragment;import com.nxt.net.zhifutongqb.utils.ZPreferenceUtils;import java.util.ArrayList;import java.util.List;import butterknife.BindView;import okhttp3.Call;import static android.app.Activity.RESULT_OK;/** * Created by Maven on 2017/2/15. * Email: cyjiang_11@163.com * Description: */public class DailyFragment extends ZBaseFragment implements SwipeRefreshLayout.OnRefreshListener, AbsListView.OnScrollListener {    private static final String TAG = "HelpDailyActivity";    @BindView(R.id.listview_common)    ListView mListview;    @BindView(R.id.swipe_container)    SwipeRefreshLayout swipeRefreshLayout;    @BindView(R.id.ztitlebar)    ZTitleBar zTitleBar;    private View footerview;    private View headerView;    private List<DailyBean.RowsBean> rowsBeanList = new ArrayList<>();    public static List<String> photoUrls = new ArrayList<>();    private boolean scrollFlag = false;// 标记是否滑动    private final static int REQUEST_CODE_HELP = 0x12;    private int page = 1, rows = 10;    public String imgUrl;    public String[] imgUrls;    @Override    protected void initView(View view) {        zTitleBar = (ZTitleBar) view.findViewById(R.id.ztitlebar);        zTitleBar.setLeftLayoutVisibility(View.GONE);        zTitleBar.setRightLayoutVisibility(View.GONE);        headerView = LayoutInflater.from(getActivity()).inflate(R.layout.layout_empty_heade, null);        mListview.addHeaderView(headerView);        footerview = LayoutInflater.from(getActivity()).inflate(R.layout.default_loading, null);        swipeRefreshLayout.setColorSchemeResources(                android.R.color.holo_blue_light,                android.R.color.holo_green_light,                android.R.color.holo_orange_light,                android.R.color.holo_red_light        );        swipeRefreshLayout.setOnRefreshListener(this);        mListview.setOnScrollListener(this);        showDialog();        getDaily();    }    @Override    protected int getLayoutId() {        return R.layout.fragment_daily;    }    private void getDaily() {        mListview.removeFooterView(footerview);        if (isnetconnected) {            String url = String.format(API.DAILY_SEARCH_URL, page, rows, ZPreferenceUtils.getPrefString(API.USER_ID, ""), 0);            OkGo.get(url)                    .tag(this)                    .execute(new StringCallback() {                        @Override                        public void onSuccess(String s, Call call, final okhttp3.Response response) {                            Log.e(TAG, "onSuccess: result-------------->" + s);                            if (page == 1) {                                DailyBean dailyBean = new Gson().fromJson(s, new TypeToken<DailyBean>() {                                }.getType());                                rowsBeanList = dailyBean.getRows();                                if (rowsBeanList.size() == 0) {                                    ZToastUtils.showShort(getActivity(), "暂无数据");                                    dismissDialog();                                } else {                                    Log.e(TAG, "onSuccess: result-------------->" + rowsBeanList.get(0).getAddress());                                    showDailyListView();                                }                            } else {                                DailyBean dailyBean = new Gson().fromJson(s, new TypeToken<DailyBean>() {                                }.getType());                                List<DailyBean.RowsBean> addRowsBeanList = dailyBean.getRows();                                if (addRowsBeanList.size() > 0) {                                    rowsBeanList.addAll(addRowsBeanList);                                    showDailyListView();                                } else {                                    ZToastUtils.showShort(getActivity(), "数据加载完毕");                                }                            }                        }                    });        } else {            if (swipeRefreshLayout.isRefreshing()) {                swipeRefreshLayout.setRefreshing(false);            }            dismissDialog();            ZToastUtils.showShort(getActivity(), R.string.net_error);        }    }    private void showDailyListView() {        mListview.setAdapter(new CommonAdapter<DailyBean.RowsBean>(getActivity(), rowsBeanList, R.layout.item_help_daily) {            @Override            public void convert(final ViewHolder holder, final DailyBean.RowsBean rowsBean, final int position, View convertView) {                String str = rowsBean.getCreatedate().trim();                String spStr[] = str.split("T");                String time = spStr[1].trim();                String date = spStr[0].trim();                String spStr1[] = time.split("\\.");                String date1 = spStr1[0].trim();                String signTime = date + "\t" + date1;                if (!rowsBean.getImageurl().equals("")) {                    if (rowsBean.getImageurl().contains(";")) {                        String[] imgUrls = rowsBean.getImageurl().split(";");                        int imNumb = imgUrls.length;                        photoUrls = new ArrayList<String>();                        for (int i = 0; i < imNumb; i++) {                            photoUrls.add(API.HOST + imgUrls[i]);                        }                        holder.setGridView(R.id.gv_help_daily_photo, photoUrls);                        Log.e(TAG, "convert: photoUrls---------->" + photoUrls);                    } else {                        imgUrl = rowsBean.getImageurl();                        photoUrls = new ArrayList<String>();                        photoUrls.add(API.HOST + imgUrl);                        holder.setGridView(R.id.gv_help_daily_photo, photoUrls);                    }                }                holder.setText(R.id.tv_content, rowsBean.getJournal());                holder.setText(R.id.tv_time, signTime);                if (!rowsBean.getAddress().equals("")) {                    holder.setVisible(R.id.tv_daily_location, true);                    holder.setText(R.id.tv_daily_location, rowsBean.getAddress());                }                //完整界面加载，取消加载动画                if (swipeRefreshLayout.isRefreshing()) {                    swipeRefreshLayout.setRefreshing(false);                }                dismissDialog();                //监听事件                holder.setOnClickListener(R.id.tv_delete, new View.OnClickListener() {                    @Override                    public void onClick(View v) {                        //删除操作                        AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());                        builder.setTitle(getString(R.string.dialog_delete_daily_title));                        builder.setMessage(getString(R.string.dialog_delete_daily_msg));                        builder.setPositiveButton(getString(R.string.ok), new DialogInterface.OnClickListener() {                            @Override                            public void onClick(DialogInterface dialog, int which) {                                if (isnetconnected) {                                    OkGo.post(API.DAILY_DELET_URL)                                            .tag(this)                                            .params("key", API.API_KEY)                                            .params("KeyValue", rowsBean.getHelpingtravelid())                                            .execute(new StringBallDialogCallback(getActivity()) {                                                @Override                                                public void onSuccess(String s, Call call, okhttp3.Response response) {                                                    Log.e(TAG, "onSuccess: result--------->" + s);                                                    RequestResponse dailResponse = new Gson().fromJson(s, new TypeToken<RequestResponse>() {                                                    }.getType());                                                    if (dailResponse.getCode().equals("1")) {                                                        rowsBeanList.remove(position);                                                        notifyDataSetChanged();                                                        ZToastUtils.showShort(getActivity(), getString(R.string.dialog_delete_daily_success));                                                    } else {                                                        ZToastUtils.showShort(getActivity(), getString(R.string.dialog_delete_daily_fail));                                                    }                                                }                                            });                                } else {                                    ZToastUtils.showShort(getActivity(), getString(R.string.net_error));                                }                            }                        });                        builder.setNegativeButton(getString(R.string.cancel), new DialogInterface.OnClickListener() {                            @Override                            public void onClick(DialogInterface dialog, int which) {                                dialog.dismiss();                            }                        });                        builder.create().show();                    }                });            }        });    }    @SuppressLint("HandlerLeak")    private Handler handler = new Handler() {        @Override        public void handleMessage(Message msg) {            if (msg.what == 0) {                page = 1;                if (rowsBeanList != null) {                    rowsBeanList.clear();                }            } else {                page++;            }            getDaily();            super.handleMessage(msg);        }    };    private void loadMore() {        new Thread(new Runnable() {            @Override            public void run() {                handler.sendEmptyMessageDelayed(1, 1500);            }        }).start();    }    @Override    public void onRefresh() {        page = 1;        if (rowsBeanList.size() > 2) {            rowsBeanList.clear();        }        getDaily();    }    @Override    public void onActivityResult(int requestCode, int resultCode, Intent data) {        super.onActivityResult(requestCode, resultCode, data);        if (resultCode == RESULT_OK) {            if (requestCode == 1) {                page = 1;                if (rowsBeanList.size() > 2) {                    rowsBeanList.clear();                }                getDaily();            }        }    }    @Override    public void onScrollStateChanged(AbsListView view, int scrollState) {        switch (scrollState) {            // 当不滚动时            // 是当屏幕停止滚动时            case AbsListView.OnScrollListener.SCROLL_STATE_IDLE:                scrollFlag = false;                // 判断滚动到底部                if (mListview.getLastVisiblePosition() == (mListview                        .getCount() - 1)) {                    mListview.addFooterView(footerview);                    loadMore();                }                // 判断滚动到顶部                if (mListview.getFirstVisiblePosition() == 0) {                }                break;            // 滚动时            case AbsListView.OnScrollListener.SCROLL_STATE_TOUCH_SCROLL:                scrollFlag = true;                break;            // 是当用户由于之前划动屏幕并抬起手指，屏幕产生惯性滑动时            case AbsListView.OnScrollListener.SCROLL_STATE_FLING:                scrollFlag = false;                break;            default:                break;        }    }    @Override    public void onScroll(AbsListView view, int firstVisibleItem, int visibleItemCount, int totalItemCount) {    }}