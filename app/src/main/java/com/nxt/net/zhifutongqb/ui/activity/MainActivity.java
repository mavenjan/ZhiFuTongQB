package com.nxt.net.zhifutongqb.ui.activity;import android.annotation.TargetApi;import android.app.ProgressDialog;import android.content.Context;import android.content.Intent;import android.net.Uri;import android.os.Build;import android.os.Environment;import android.os.PowerManager;import android.support.v4.app.Fragment;import android.support.v4.app.FragmentTransaction;import android.util.Log;import android.view.KeyEvent;import android.widget.FrameLayout;import android.widget.Toast;import com.ashokvarma.bottomnavigation.BottomNavigationBar;import com.ashokvarma.bottomnavigation.BottomNavigationItem;import com.google.gson.Gson;import com.google.gson.reflect.TypeToken;import com.jaeger.library.StatusBarUtil;import com.lzy.okgo.OkGo;import com.lzy.okgo.callback.StringCallback;import com.nxt.net.zhifutongqb.R;import com.nxt.net.zhifutongqb.app.API;import com.nxt.net.zhifutongqb.bean.CheckUpdateInfo;import com.nxt.net.zhifutongqb.runtimepermissions.PermissionsManager;import com.nxt.net.zhifutongqb.runtimepermissions.PermissionsResultAction;import com.nxt.net.zhifutongqb.ui.fragment.HomeFragment;import com.nxt.net.zhifutongqb.ui.fragment.NewsFragment;import com.nxt.net.zhifutongqb.ui.fragment.PersonFragment;import com.nxt.net.zhifutongqb.app.MyApplication;import com.nxt.net.zhifutongqb.base.BaseActivity;import com.nxt.net.zhifutongqb.ui.fragment.DailyFragment;import com.nxt.net.zhifutongqb.utils.CommonUtils;import com.nxt.net.zhifutongqb.utils.PackageUtil;import com.nxt.net.zhifutongqb.utils.ZPreferenceUtils;import com.nxt.net.zhifutongqb.utils.ZToastUtils;import com.qiangxi.checkupdatelibrary.dialog.ForceUpdateDialog;import java.util.ArrayList;import java.util.List;import okhttp3.Call;import okhttp3.Response;/** * Created by Maven on 2017/2/15. * Email: cyjiang_11@163.com * Description: */public class MainActivity extends BaseActivity implements BottomNavigationBar.OnTabSelectedListener {    private static final String TAG = "MainActivity";    private boolean islogin = false;    private FrameLayout mframeLayout;    private BottomNavigationBar mBottomNavigationBar;    private List<Fragment> fragmentList = new ArrayList<>();    private int index;    // 当前fragment的index    private int currentindex;    private CheckUpdateInfo mCheckUpdateInfo;    private ForceUpdateDialog mForceUpdateDialog;    @Override    protected void initView() {        application.addActivity(this);        islogin = ZPreferenceUtils.getPrefBoolean(API.IS_LOGIN, false);        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {            String packageName = getPackageName();            PowerManager pm = (PowerManager) getSystemService(Context.POWER_SERVICE);            if (!pm.isIgnoringBatteryOptimizations(packageName)) {                Intent intent = new Intent();                intent.setAction(android.provider.Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);                intent.setData(Uri.parse("package:" + packageName));                if (intent.resolveActivity(getPackageManager()) != null) {                    startActivity(intent);                }//                startActivity(intent);            }        }        // runtime permission for android 6.0, just require all permissions here for simple        requestPermissions();        HomeFragment homeFragment = new HomeFragment();        NewsFragment newsFragment = new NewsFragment();//        DailyFragment dailyFragment = new DailyFragment();        PersonFragment personFragment = new PersonFragment();        fragmentList.add(homeFragment);        fragmentList.add(newsFragment);//        fragmentList.add(dailyFragment);        fragmentList.add(personFragment);        mframeLayout = (FrameLayout) findViewById(R.id.fl_home);        mBottomNavigationBar = (BottomNavigationBar) findViewById(R.id.bottom_navigation_bar);        mBottomNavigationBar.setMode(BottomNavigationBar.MODE_FIXED);        mBottomNavigationBar.setBackgroundStyle(BottomNavigationBar.BACKGROUND_STYLE_STATIC);        mBottomNavigationBar                .addItem(new BottomNavigationItem(R.drawable.ic_home, "主页").setActiveColorResource(R.color.colorPrimary))                .addItem(new BottomNavigationItem(R.drawable.ic_news, "资讯").setActiveColorResource(R.color.colorPrimary))//                .addItem(new BottomNavigationItem(R.drawable.ic_daily, "日志").setActiveColorResource(R.color.colorPrimary))                .addItem(new BottomNavigationItem(R.drawable.ic_me, "我的").setActiveColorResource(R.color.colorPrimary))                .setFirstSelectedPosition(0)                .initialise();        // 添加显示第一个fragment        getSupportFragmentManager().beginTransaction()                .add(R.id.fl_home, homeFragment)                .add(R.id.fl_home, personFragment)                .hide(personFragment)                .show(homeFragment)                .commit();        mBottomNavigationBar.setTabSelectedListener(this);        checkUpdate(true);  //检测热更新和版本更新    }    @TargetApi(23)    private void requestPermissions() {        PermissionsManager.getInstance().requestAllManifestPermissionsIfNecessary(this, new PermissionsResultAction() {            @Override            public void onGranted() {//				Toast.makeText(MainActivity.this, "All permissions have been granted", Toast.LENGTH_SHORT).show();            }            @Override            public void onDenied(String permission) {                //Toast.makeText(MainActivity.this, "Permission " + permission + " has been denied", Toast.LENGTH_SHORT).show();            }        });    }    @Override    protected int getLayout() {        return R.layout.activity_main;    }    @Override    public void onTabSelected(int position) {        if (currentindex != position) {            FragmentTransaction trx = getSupportFragmentManager().beginTransaction();            trx.hide(fragmentList.get(currentindex));            if (!fragmentList.get(position).isAdded()) {                trx.add(R.id.fl_home, fragmentList.get(position));            }            trx.show(fragmentList.get(position)).commit();        }        currentindex = position;    }    @Override    public void onTabUnselected(int position) {    }    @Override    public void onTabReselected(int position) {    }    @Override    protected void setStatusBar() {        StatusBarUtil.setTranslucentForImageViewInFragment(MainActivity.this, null);    }    public void logout() {        final ProgressDialog pd = new ProgressDialog(this);        String st = getResources().getString(R.string.Are_logged_out);        pd.setMessage(st);        pd.setCanceledOnTouchOutside(false);        pd.show();        runOnUiThread(new Runnable() {            public void run() {                pd.dismiss();                // 重新显示登陆页面                MyApplication.getInstance().cleanspf();                (MainActivity.this).finish();                startActivity(new Intent(MainActivity.this, LoginActivity.class));            }        });    }    private void checkUpdate(final boolean isauto) {        if (CommonUtils.isNetWorkConnected(this)) {            final int code = new PackageUtil(this).getVersionCode();            OkGo.get(API.APP_VERSION_URL)                    .tag(this)                    .execute(new StringCallback() {                        @Override                        public void onSuccess(String s, Call call, Response response) {                            Log.e(TAG, "onSuccess: result----------->" + s);                            mCheckUpdateInfo = new Gson().fromJson(s, new TypeToken<CheckUpdateInfo>() {                            }.getType());                            if (mCheckUpdateInfo.getVersionCode() > code) {                                showForceUpdateDialog(mCheckUpdateInfo);                            } else {                                if (!isauto)                                    ZToastUtils.showShort(MainActivity.this, R.string.is_newest_version);                            }                        }                    });        } else {            ZToastUtils.showShort(this, R.string.net_error);        }    }    /**     * 强制更新,checkupdatelibrary中提供的默认强制更新Dialog,您完全可以自定义自己的Dialog,     */    public void showForceUpdateDialog(CheckUpdateInfo mCheckUpdateInfo) {        Log.e(TAG, "showForceUpdateDialog: size-------------->" + mCheckUpdateInfo.getAppSize());        Log.e(TAG, "showForceUpdateDialog: getAppReleaseTime-------------->" + mCheckUpdateInfo.getAppReleaseTime());        Log.e(TAG, "showForceUpdateDialog: getAppVersionName-------------->" + mCheckUpdateInfo.getAppVersionName());        Log.e(TAG, "showForceUpdateDialog: getAppUpdateDesc-------------->" + mCheckUpdateInfo.getAppUpdateDesc());        mForceUpdateDialog = new ForceUpdateDialog(MainActivity.this);        mForceUpdateDialog.setAppSize(mCheckUpdateInfo.getAppSize())                .setDownloadUrl(API.APP_DOWNLOAD_URL)                .setTitle(mCheckUpdateInfo.getAppName() + "有更新啦")                .setReleaseTime(mCheckUpdateInfo.getAppReleaseTime())                .setVersionName(mCheckUpdateInfo.getAppVersionName())                .setUpdateDesc(mCheckUpdateInfo.getAppUpdateDesc())                .setFileName(getString(R.string.app_name) + ".apk")                .setFilePath(Environment.getExternalStorageDirectory().getPath() + "/Acheckupdatelib")                .show();    }    private long exitTime;    /**     * 重写主界面下的返回键     */    @Override    public boolean onKeyDown(int keyCode, KeyEvent event) {        if (keyCode == KeyEvent.KEYCODE_BACK) {            if (event.getAction() == KeyEvent.ACTION_DOWN) {                if ((System.currentTimeMillis() - exitTime) > 2000) {                    Toast.makeText(getApplicationContext(), getString(R.string.exit_notice),                            Toast.LENGTH_SHORT).show();                    exitTime = System.currentTimeMillis();                } else {//                    moveTaskToBack(false);                    MyApplication.getInstance().exit();                    finish();                }            }            return true;        }        return super.onKeyDown(keyCode, event);    }}